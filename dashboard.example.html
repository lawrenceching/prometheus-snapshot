<html>
    <head>
        <title>Dashboard</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js" integrity="sha512-k37wQcV4v2h6jgYf5IUz1MoSKPpDs630XGSmCaCCOXxy2awgAWKHGZWr9nMyGgk3IOxA1NxdkN8r1JHgkUtMoQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script type="module" src="./src/core/echart-option-builder.js"></script>
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }

            .container {
                margin-left: 10px;
                margin-right: 10px;
            }

            .tile {
                width: 100%;
                height: 500px;
            }


            /*.container {*/
            /*    display: flex;*/
            /*    flex-direction: row*/
            /*}*/
        </style>
    </head>
    <body>
        <h1>Dashboard</h1>
        <div id="dashboard" class="container text-center">

        </div>
        <script id="persistent-data">
            window.originFetch = window.fetch;
            window.fetch = function(url) {
                const cacheResp = window.fetchCache[url];
                if(cacheResp !== undefined) {
                    console.log(`return cached HTTP response: ${url}`)
                    return {
                      ok: true,
                      url: url,
                      json: async () => {
                          return JSON.parse(cacheResp)
                      },
                      text: async() => {
                          return cacheResp;
                      }
                    }
                }

                return window.originFetch.apply(null, arguments)
            }
            // map of URL to HTTP response
            window.fetchCache = {}

        </script>
        <script type="module" type="text/javascript">

            import buildEchartOption from "./src/core/echart-option-builder.js";
            import Prometheus from "./src/datasource/prometheus.js";
            import { UNITS } from "./src/core/echart-option-builder.js"

            const TYPE_TIME_SERIES = 'time-series';
            function renderExampleTimeSeries(panel, elementId) {
                var chart = echarts.init(document.getElementById(elementId));

                const now = Date.now();
                const dataSet = [
                    {
                        metric: 'pod-name_container_name',
                        data: [
                            {time: now + 1000 * 10, value: Math.floor(Math.random())},
                            {time: now + 1000 * 20, value: Math.floor(Math.random())},
                            {time: now + 1000 * 30, value: Math.floor(Math.random())},
                            {time: now + 1000 * 40, value: Math.floor(Math.random())},
                            {time: now + 1000 * 50, value: Math.floor(Math.random())},
                            {time: now + 1000 * 60, value: Math.floor(Math.random())},
                            {time: now + 1000 * 70, value: Math.floor(Math.random())},
                            {time: now + 1000 * 80, value: Math.floor(Math.random())},
                            {time: now + 1000 * 90, value: Math.floor(Math.random())},
                            {time: now + 1000 * 100, value: Math.floor(Math.random())},
                        ]
                    }
                ]
                const option = buildEchartOption(dataSet, {
                    unit: panel.unit,
                })
                chart.setOption(option);
            }

            /**

             * data is:
             * [
             *             {
             *                 "metric": {
             *                     "handler": "subroute",
             *                     "instance": "localhost:2019",
             *                     "job": "caddy",
             *                     "server": "srv0"
             *                 },
             *                 "values": [
             *                     [
             *                         1714492874.299,
             *                         "1.3555555555555554"
             *                     ],
             *                     [
             *                         1714496472.299,
             *                         "1.2"
             *                     ]
             *                 ]
             *             }
             *
             * @param panel
             * @param elementId
             * @param data
             */
            function renderTimeSeries(panel, elementId, data) {
                console.log(`render time series panel: data=${JSON.stringify(data)}`)
                var chart = echarts.init(document.getElementById(elementId));

                const option = buildEchartOption(data, {
                    unit: panel.unit,
                })
                chart.setOption(option);
            }

            function prometheusResponseToEchartData(resp) {

                /**
                 * resp is:
                 * {
                 *     "status": "success",
                 *     "data": {
                 *         "resultType": "matrix",
                 *         "result": [
                 *             {
                 *                 "metric": {
                 *                     "handler": "subroute",
                 *                     "instance": "localhost:2019",
                 *                     "job": "caddy",
                 *                     "server": "srv0"
                 *                 },
                 *                 "values": [
                 *                     [
                 *                         1714492874.299,
                 *                         "1.3555555555555554"
                 *                     ],
                 *                     [
                 *                         1714496472.299,
                 *                         "1.2"
                 *                     ]
                 *                 ]
                 *             }
                 *         ]
                 *     }
                 * }
                 */

                return resp.data.result;

            }

            const dashboardEl = document.getElementById('dashboard');

            const dashboard = {
                title: 'Performance Dashboard',
                dataSources: [
                    {
                        type: "prometheus",
                        address: 'https://prometheus.demo.do.prometheus.io'
                    }
                ],
                panels: [
                    {
                        title: 'http_request_per_seconds',
                        type: 'time-series',
                        query: "rate(caddy_http_requests_total[1m])",
                        unit: UNITS.number,
                        dataSource: 'prometheus'
                    },
                ]
            }

            const address = dashboard.dataSources[0].address;
            const prometheus = new Prometheus(address);
            const panel = dashboard.panels[0];
            const {title, query} = panel;

            let indexOfPanelId = 0;
            const echartInitFunctions = [];

            const panels = dashboard.panels;
            for (const panel of panels) {
                const id = `panel-${++indexOfPanelId}`;
                dashboardEl.innerHTML = dashboardEl.innerHTML + `
                <div class="row">
                    <div class="panel-title">${panel.title}</div>
                    <div id="${id}" class="col tile"></div>
                </div>
                `

                const {title, query, type} = panel;

                const resp = await prometheus.queryRange(query, 1714492874.299, 1714496474.299);
                let data = null;
                if(!resp.ok) {
                    console.log(`failed to fetch data from ${address}`)
                } else {
                    const json = data = await resp.json();
                    window.fetchCache[resp.url] = JSON.stringify(json);
                }

                const scriptEl = document.getElementById('persistent-data')
                scriptEl.innerHTML = `${scriptEl.innerHTML}
                 window.fetchCache = ${JSON.stringify(window.fetchCache)}
                `
                console.log(`persistent "${title}" data into HTML`);

                switch (type) {
                    case TYPE_TIME_SERIES: {
                        echartInitFunctions.push(() => {
                            renderTimeSeries(panel, id, prometheusResponseToEchartData(data));
                        })
                        break;
                    }
                }
            }

            echartInitFunctions.forEach(fn => fn());
        </script>
    </body>
</html>