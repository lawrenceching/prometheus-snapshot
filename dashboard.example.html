<html lang="en">
<head>
    <title>Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"
            integrity="sha512-k37wQcV4v2h6jgYf5IUz1MoSKPpDs630XGSmCaCCOXxy2awgAWKHGZWr9nMyGgk3IOxA1NxdkN8r1JHgkUtMoQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script type="module" src="./src/core/echart-option-builder.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #dashboard {
            display: flex;
            flex-direction: column;
            gap: 100px;
            padding: 10px 10px 10px 10px;
        }

        #control {
            padding: 10px;
        }

        .tile {
            margin: auto;
            height: 30%;
        }

        .container {
            /*margin: 50px 10px;*/
        }

        .chart {
            width: 1500px;
            height: 1500px;
        }

        .divider {
            background-color: grey;
            width: 100%;
            height: 1px;
        }

        .chart svg {
            user-select: auto !important;
        }


        /*.container {*/
        /*    display: flex;*/
        /*    flex-direction: row*/
        /*}*/
    </style>
</head>
<body>
<h1>Dashboard</h1>
<div id="control">
    <div class="mb-3">
        <label for="dataSource" class="form-label">Data Source</label>
        <input class="form-control" id="dataSource" placeholder="https://prometheus.demo.do.prometheus.io">
    </div>
    <div class="mb-3">
        <label for="dashboardDefinition" class="form-label">Dashboard</label>
        <textarea class="form-control" id="dashboardDefinition" rows="3"></textarea>
    </div>
</div>
<div id="dashboard" class="container text-center">
</div>
<script id="persistent-data">
    window.originFetch = window.fetch;
    window.fetch = function (url) {
        const cacheResp = window.fetchCache[url];
        if (cacheResp !== undefined) {
            console.log(`return cached HTTP response: ${url}`)
            return {
                ok: true,
                url: url,
                json: async () => {
                    return JSON.parse(cacheResp)
                },
                text: async () => {
                    return cacheResp;
                }
            }
        }

        return window.originFetch.apply(null, arguments)
    }
    // map of URL to HTTP response
    window.fetchCache = {}

</script>
<script type="module">

    window.echartOptions = {
        renderer: 'svg'
    }

    import buildEchartOption from "./src/core/echart-option-builder.js";
    import Prometheus from "./src/datasource/prometheus.js";
    import {UNITS} from "./src/core/echart-option-builder.js"

    const TYPE_TIME_SERIES = 'time-series';
    const TYPE_ROW = 'row'; // a row contains another set of panels
    function renderExampleTimeSeries(panel, elementId) {
        var chart = echarts.init(document.getElementById(elementId));

        const now = Date.now();
        const dataSet = [
            {
                metric: 'pod-name_container_name',
                values: [
                    {time: now + 1000 * 10, value: Math.floor(Math.random())},
                    {time: now + 1000 * 20, value: Math.floor(Math.random())},
                    {time: now + 1000 * 30, value: Math.floor(Math.random())},
                    {time: now + 1000 * 40, value: Math.floor(Math.random())},
                    {time: now + 1000 * 50, value: Math.floor(Math.random())},
                    {time: now + 1000 * 60, value: Math.floor(Math.random())},
                    {time: now + 1000 * 70, value: Math.floor(Math.random())},
                    {time: now + 1000 * 80, value: Math.floor(Math.random())},
                    {time: now + 1000 * 90, value: Math.floor(Math.random())},
                    {time: now + 1000 * 100, value: Math.floor(Math.random())},
                ]
            }
        ]
        const option = buildEchartOption(panel, dataSet, {
            unit: panel.unit,
        })
        chart.setOption(option);
    }

    /**

     * data is:
     * [
     *             {
     *                 "metric": {
     *                     "handler": "subroute",
     *                     "instance": "localhost:2019",
     *                     "job": "caddy",
     *                     "server": "srv0"
     *                 },
     *                 "values": [
     *                     [
     *                         1714492874.299,
     *                         "1.3555555555555554"
     *                     ],
     *                     [
     *                         1714496472.299,
     *                         "1.2"
     *                     ]
     *                 ]
     *             }
     *
     * @param panel
     * @param elementId
     * @param data
     */
    function renderTimeSeries(panel, elementId, data) {
        console.log(`render time series panel: data=${JSON.stringify(data)}`)
        var chart = echarts.init(document.getElementById(elementId), null, {
            renderer: window.echartOptions.renderer || 'svg',
            useDirtyRect: false
        });

        const option = buildEchartOption(panel, data, {
            unit: panel.unit,
        })
        chart.setOption(option);
        console.log(`register resize event listener for echart ${panel.title}`);
        window.addEventListener('resize', chart.resize)
    }

    function prometheusResponseToEchartData(resp) {

        /**
         * resp is:
         * {
         *     "status": "success",
         *     "data": {
         *         "resultType": "matrix",
         *         "result": [
         *             {
         *                 "metric": {
         *                     "handler": "subroute",
         *                     "instance": "localhost:2019",
         *                     "job": "caddy",
         *                     "server": "srv0"
         *                 },
         *                 "values": [
         *                     [
         *                         1714492874.299,
         *                         "1.3555555555555554"
         *                     ],
         *                     [
         *                         1714496472.299,
         *                         "1.2"
         *                     ]
         *                 ]
         *             }
         *         ]
         *     }
         * }
         */

        return resp.data.result;

    }

    function onDashboardUpdated() {

        function renderPanelInElement(panel) {
            const id = "echart-" + uuidv4();
            const { title, query } = panel;

            echartInitFunctions.push(async () => {
                const query  = panel.query;
                const resp = await prometheus.queryRange(query, startTimeInUnixSeconds, endTimeInUnixSeconds);
                let data = null;
                if (!resp.ok) {
                    console.log(`failed to fetch data from ${address}`)
                } else {
                    const json = data = await resp.json();
                    window.fetchCache[resp.url] = JSON.stringify(json);
                    console.log(`persistent "${title}" data into HTML`);
                }

                renderTimeSeries(panel, id, prometheusResponseToEchartData(data));
                console.log(`rendered chart ${panel.title} to container ${id}`)
            })

            console.log(`created echart container ${id} for panel ${title}`)

            if (window.echartOptions.renderer === 'svg') {
                return `<div>
                    <div id="${id}" class="chart"></div>
                </div>`
            } else {
                return `<div>
                    <div><h3>${title}</h3></div>
                    <div>${query}</div>
                    <div id="${id}" class="chart"></div>
                </div>`
            }
        }

        function renderPanelsInElement(panels) {
            return panels
                .map(panel => {
                    return `
                <div class="col"> ${renderPanelInElement(panel)}</div>
                `
                })
                .join("\n")
        }

        const el = document.querySelector("#dashboardDefinition")
        let dashboard = '';
        try {
            dashboard = JSON.parse(el.value);
        } catch (e) {
            console.log(`unable to parse dashboard JSON definition: ${e}`)
            return;
        }

        const address = dashboard.dataSources[0].address;
        const prometheus = new Prometheus(address);
        const panel = dashboard.panels[0];
        const {title, query} = panel;

        let indexOfPanelId = 0;
        const echartInitFunctions = [];

        const panels = dashboard.panels;
        for (const panel of panels) {

            const {title, query, type} = panel;

            switch (type) {
                case TYPE_TIME_SERIES: {

                    if(query === null || query === undefined || query.trim() === '') {
                        continue;
                    }

                    const id = `panel-${++indexOfPanelId}`;
                    dashboardEl.innerHTML = dashboardEl.innerHTML + `
                <div class="tile row">
                    <div class="panel-title">${panel.title}</div>
                    <div id="${id}" class="col tile">${renderPanelInElement(panel)}</div>
                </div>
                <div class="tile divider"></div>
                `

                    break;
                }
                case TYPE_ROW: {
                    const subPanels = panel.panels;
                    const rowId = `echart-row-${uuidv4()}`;
                    console.log(`rendering row ${title} with ${subPanels.length} sub panels`);
                    dashboardEl.innerHTML = dashboardEl.innerHTML + `

                    <div class="tile container text-center">
                        <div class="row">
                            <div class="h1 panel-title">${panel.title}</div>
                            <button class="btn btn-dark" type="button" data-bs-toggle="collapse" data-bs-target="#${rowId}" aria-expanded="false" aria-controls="${rowId}">Collapse</button>
                        </div>
                        <div class="row collapse show" id="${rowId}">${renderPanelsInElement(subPanels)}</div>

                    </div>
                    <div class="tile divider"></div>
`
                }
            }
        }

        echartInitFunctions.forEach(fn => fn());
    }


    const endTimeInUnixSeconds = Date.now() / 1000
    const startTimeInUnixSeconds = endTimeInUnixSeconds - 900;

    const dashboardEl = document.getElementById('dashboard');

    const dashboard = {
        title: 'Performance Dashboard',
        dataSources: [
            {
                type: "prometheus",
                address: 'https://prometheus.demo.do.prometheus.io'
            }
        ],
        panels: [
            {
                title: 'CPU Usage',
                type: 'time-series',
                query: "sum(rate(process_cpu_seconds_total[1m])) by (instance, job) * 100",
                unit: UNITS.percent_0_to_1,
                dataSource: 'prometheus'
            },
            {
                title: 'Caddy',
                type: 'row',
                panels: [
                    {
                        title: 'caddy_http_response_duration',
                        type: 'time-series',
                        query: "sum(rate(caddy_http_response_duration_seconds_sum[5m])) by (instance, method, code)/sum(rate(caddy_http_response_duration_seconds_count[5m])) by (instance, method, code)",
                        unit: UNITS.second,
                        dataSource: 'prometheus'
                    },
                    {
                        title: 'caddy_http_response_duration GET 200',
                        type: 'time-series',
                        query: "sum(rate(caddy_http_response_duration_seconds_sum{method=\"GET\", code=\"200\"}[5m])) by (instance, method, code)/sum(rate(caddy_http_response_duration_seconds_count{method=\"GET\", code=\"200\"}[5m])) by (instance, method, code)",
                        unit: UNITS.second,
                        dataSource: 'prometheus'
                    },
                ]
            },
        ]
    }

    const defaultDashboardDefinition = dashboard;

    const dashboardDefinitionTextArea = document.querySelector("#dashboardDefinition")

    if(dashboardDefinitionTextArea.value === '') {
        dashboardDefinitionTextArea.value = JSON.stringify(defaultDashboardDefinition, null, 4);
        console.log(`initialized default dashboard definition`);
    }

    function uuidv4() {
        return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
            (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
        );
    }

    onDashboardUpdated();

</script>
</body>
</html>