<html>
    <head>
        <title>Dashboard</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js" integrity="sha512-k37wQcV4v2h6jgYf5IUz1MoSKPpDs630XGSmCaCCOXxy2awgAWKHGZWr9nMyGgk3IOxA1NxdkN8r1JHgkUtMoQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script type="module" src="./src/core/echart-option-builder.js"></script>
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }

            .container {
                margin-left: 10px;
                margin-right: 10px;
            }

            .tile {
                width: 100%;
                height: 500px;
            }


            /*.container {*/
            /*    display: flex;*/
            /*    flex-direction: row*/
            /*}*/
        </style>
    </head>
    <body>
        <h1>Dashboard</h1>
        <div id="dashboard" class="container text-center">

        </div>
        <script id="persistent-data">
            console.log(`load persistent-data`)
            window.persistentData = {}
        </script>
        <script type="module" type="text/javascript">

            import buildEchartOption from "./src/core/echart-option-builder.js";
            import Prometheus from "./src/datasource/prometheus.js";
            import { UNITS } from "./src/core/echart-option-builder.js"

            const TYPE_TIME_SERIES = 'time-series';

            console.log(`persistent data: `, window.persistentData);
            function renderExampleTimeSeries(panel, elementId) {
                var chart = echarts.init(document.getElementById(elementId));

                const now = Date.now();
                const dataSet = [
                    {
                        metric: 'pod-name_container_name',
                        data: [
                            {time: now + 1000 * 10, value: Math.floor(Math.random())},
                            {time: now + 1000 * 20, value: Math.floor(Math.random())},
                            {time: now + 1000 * 30, value: Math.floor(Math.random())},
                            {time: now + 1000 * 40, value: Math.floor(Math.random())},
                            {time: now + 1000 * 50, value: Math.floor(Math.random())},
                            {time: now + 1000 * 60, value: Math.floor(Math.random())},
                            {time: now + 1000 * 70, value: Math.floor(Math.random())},
                            {time: now + 1000 * 80, value: Math.floor(Math.random())},
                            {time: now + 1000 * 90, value: Math.floor(Math.random())},
                            {time: now + 1000 * 100, value: Math.floor(Math.random())},
                        ]
                    }
                ]
                const option = buildEchartOption(dataSet, {
                    unit: panel.unit,
                })
                chart.setOption(option);
            }

            function renderTimeSeries(panel, elementId, data) {
                console.log(`render time series panel: data=${JSON.stringify(data)}`)
                var chart = echarts.init(document.getElementById(elementId));
                const dataSet = [
                    {
                        metric: 'pod-name_container_name',
                        data
                    }
                ]
                const option = buildEchartOption(dataSet, {
                    unit: panel.unit,
                })
                chart.setOption(option);
            }

            function prometheusResponseToEchartData(resp) {

                /**
                 * resp is:
                 * {
                 *     "status": "success",
                 *     "data": {
                 *         "resultType": "matrix",
                 *         "result": [
                 *             {
                 *                 "metric": {
                 *                     "handler": "subroute",
                 *                     "instance": "localhost:2019",
                 *                     "job": "caddy",
                 *                     "server": "srv0"
                 *                 },
                 *                 "values": [
                 *                     [
                 *                         1714492874.299,
                 *                         "1.3555555555555554"
                 *                     ],
                 *                     [
                 *                         1714496472.299,
                 *                         "1.2"
                 *                     ]
                 *                 ]
                 *             }
                 *         ]
                 *     }
                 * }
                 */

                return resp.data.result[0].values.map(value => {
                    return [
                        value[0],
                        Math.floor(value[1] * 10) / 10
                    ]
                });

            }

            const dashboardEl = document.getElementById('dashboard');

            const dashboard = {
                title: 'Performance Dashboard',
                dataSources: [
                    {
                        type: "prometheus",
                        address: 'https://prometheus.demo.do.prometheus.io'
                    }
                ],
                panels: [
                    {
                        title: 'http_request_per_seconds',
                        type: 'time-series',
                        query: "rate(caddy_http_requests_total[1m])",
                        unit: UNITS.number,
                        dataSource: 'prometheus'
                    },
                ]
            }

            const address = dashboard.dataSources[0].address;
            const prometheus = new Prometheus(address);
            const panel = dashboard.panels[0];
            const {title, query} = panel;

            let indexOfPanelId = 0;
            const echartInitFunctions = [];

            const panels = dashboard.panels;
            for (const panel of panels) {
                const id = `panel-${++indexOfPanelId}`;
                dashboardEl.innerHTML = dashboardEl.innerHTML + `
                <div class="row">
                    <div class="panel-title">${panel.title}</div>
                    <div id="${id}" class="col tile"></div>
                </div>
                `

                const {title, query, type} = panel;
                let data = window.persistentData[title];

                if(data === undefined) {
                    console.log(`no persistent data found for "${title}", try to fetch from remote server ${address}`)
                    const resp = await prometheus.queryRange(query, 1714492874.299, 1714496474.299);

                    if(!resp.ok) {
                        console.log(`failed to fetch data from ${address}`)
                    } else {
                        const json = await resp.json();
                        data = window.persistentData[title] = prometheusResponseToEchartData(json);
                    }

                    const scriptEl = document.getElementById('persistent-data')
                    scriptEl.innerHTML = `${scriptEl.innerHTML}
                     window.persistentData["${title}"] = ${JSON.stringify(data)}
                    `
                    console.log(`persistent "${title}" data into HTML`);
                }

                switch (type) {
                    case TYPE_TIME_SERIES: {
                        echartInitFunctions.push(() => {
                            renderTimeSeries(panel, id, data);
                        })
                        break;
                    }
                }
            }

            echartInitFunctions.forEach(fn => fn());
        </script>
    </body>
</html>